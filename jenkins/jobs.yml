- project:
    name: NGX CI jobs
    tla: ngx
    cm: ansible
    cm_scm_group: ansible-roles
    first-environment: qa
    product: bf-nginx
    role: bf-nginx
    jobs:
    - '{tla}_{cm}_ci_build'
    extended-jobs:
    - tla_package_isolated:
        package-metadata:
          dependencies:
            core:
            - name: sena_ansible_build
              project-name: sena_ansible_ci_build
              promotion-name: passed-ci
            - name: sensu_ansible_build
              project-name: sensu_ansible_ci_build
              promotion-name: passed-ci
            - name: mon_build
              project-name: mon_ci_build
              promotion-name: passed-ci
            - name: tspf_ansible_build
              project-name: tspf_ansible_ci_build
              promotion-name: passed-ci
            - name: slgc_ansible_build
              project-name: slgc_ansible_ci_build
              promotion-name: passed-ci
            - name: cpb_ci_build
              project-name: cpb_ci_build
              promotion-name: passed-ci
            alpha:
            - name: ssl_ansible_ci_build
              project-name: ssl_ansible_ci_build
              promotion-name: passed-ci
            - name: bf_jce_base_ansible_ci_build
              project-name: bf_jce_base_ansible_ci_build
              promotion-name: passed-ci
            - name: bf_java_base_ansible_ci_build
              project-name: bf_java_base_ansible_ci_build
              promotion-name: passed-ci
            - name: geoip_ansible_ci
              project-name: geoip_ansible_ci_build
              promotion-name: passed-ci

- job:
    name: ngx_ci_build
    logrotate:
      numToKeep: 30
    wrappers:
    - timestamps
    - ansicolor
    - workspace-cleanup
    - artifactory_push:
        key: bf-ngx
        pattern: ${workspace}/target/**/*.rpm=>ngx/${BUILD_NUMBER}/
    parameters:
    - devops_ci_build
    - string:
        name: nginx_version
        default: 1.12.2
    - string:
        name: nginx_release
        default: '2'

    builders:
    - get_devops_framework
    - shell: |
        mkdir -p target/x86_64
        wget https://artifactory-prd.prd.betfair/artifactory/centos-epel/7/x86_64/n/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm  -o target/x86_64/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm
    - generate_ci_metadata_extra:
        product: ngx_ci_build
        extra_data: release=${nginx_release} application_version=${nginx_version}
          app_name=bf-ngx
    - create_artifactory_yum_repo:
        repo_name: bf-ngx
    publishers:
    - archive:
        artifacts: metadata.txt
