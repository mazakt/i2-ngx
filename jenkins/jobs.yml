- project:
    name: NGX CI jobs
    tla: ngx
    cm: ansible
    cm_scm_group: ansible-roles
    first-environment: qa
    product: bf-nginx
    role: bf-nginx
    dc:
    - 'ie1'
    - 'ie2'
    jobs:
    - '{tla}_{cm}_ci_build'
    - '{tla}_integration-tests-{dc}'
    - 'tla_package_minor_version_multi_dest'
    # extended-jobs:
    # - tla_package_isolated:
    #     package-metadata:
    #       dependencies:
    #         core:
    #         - name: sena_ansible_build
    #           project-name: sena_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: sensu_ansible_build
    #           project-name: sensu_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: mon_build
    #           project-name: mon_ci_build
    #           promotion-name: passed-ci
    #         - name: tspf_ansible_build
    #           project-name: tspf_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: slgc_ansible_build
    #           project-name: slgc_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: cpb_ci_build
    #           project-name: cpb_ci_build
    #           promotion-name: passed-ci
    #         alpha:
    #         - name: ssl_ansible_ci_build
    #           project-name: ssl_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: bf_jce_base_ansible_ci_build
    #           project-name: bf_jce_base_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: bf_java_base_ansible_ci_build
    #           project-name: bf_java_base_ansible_ci_build
    #           promotion-name: passed-ci
    #         - name: geoip_ansible_ci
    #           project-name: geoip_ansible_ci_build
    #           promotion-name: passed-ci

- package-metadata_tla_defaults: &package-metadata_tla_defaults
    name: 'package-metadata_tla_minor_version_multi_dest'
    dependencies:
      core: &package-metadata_tla_defaults_core
        - name: devops_build
          project-name: "devops_ci_build"
          promotion-name: "passed-ci"
          order: 10
        - name: 'lin_package'
          project-name: "lin_package"
          promotion-name: "PRD_Promoted"
          metadata: "${{lin_package}}artifact/dep-metadata.txt"
          order: 11
        - name: sdn_build
          project-name: "sdn_ci_build"
          promotion-name: "passed-ci"
          order: 12
        - name: lb_build
          project-name: "lb_ci_build"
          promotion-name: "passed-ci"
          order: 13
        - name: inv_build
          project-name: "inv_ci_build"
          promotion-name: "passed-ci"
          order: 14
        - name: splunkc_package
          project-name: "splunkc_package"
          promotion-name: "dependencies-packaged"
          metadata: "${{splunkc_package}}artifact/dep-metadata.txt"
          order: 15
        - name: sec_build
          project-name: "sec_ci_build"
          promotion-name: "passed-ci"
          order: 16
      alpha:
        - name: '{tla}_build'
          project-name: '{tla}_ci_build'
          promotion-name: "passed-ci"
          order: 10
        - name: '{tla}_{cm}_build'
          project-name: '{tla}_{cm}_ci_build'
          promotion-name: "passed-ci"
          order: 11



- job-template: &base_tla_package_definition_multi_dest
    name: '{tla}_package'
    id: 'tla_package_minor_version_multi_dest'
    project-type: freestyle
    version: 0
    quiet-period: 5
    logrotate:
      numToKeep: 30

    package-metadata:
        manifest: '$WORKSPACE/dep-metadata.txt'
        package: '$BUILD_NUMBER'
        metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'

    scm:
      - clone_gitlab_project:
          project_path: 'devops/framework'

    publishers:
      - archive:
          artifacts: 'package\{tla}-manifest-$BUILD_NUMBER.{version}.json, dep-metadata.txt'

    wrappers:
      - timestamps
      - mask-passwords
      - workspace-cleanup:
          dirmatch: true
          include: '*'
      - artifactory_push:
          key: 'releases'
          pattern:
           !j2: |
           {% for thisdc in dc -%}
             $WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/{{first_environment|default('qa')}}/,$WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/hotfix/,
           {%- endfor %}

- job:
    name: ngx_ci_build
    logrotate:
      numToKeep: 30
    wrappers:
    - timestamps
    - ansicolor
    - workspace-cleanup
    - artifactory_push:
        key: bf-ngx
        pattern: ${workspace}/target/**/*.rpm=>ngx/${BUILD_NUMBER}/
    parameters:
    - devops_ci_build
    - string:
        name: nginx_version
        default: 1.12.2
    - string:
        name: nginx_release
        default: '2'

    builders:
    - get_devops_framework
    - shell: |
        mkdir -p target/x86_64
        wget https://artifactory-prd.prd.betfair/artifactory/centos-epel/7/x86_64/n/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm  -o target/x86_64/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm
    - generate_ci_metadata_extra:
        product: ngx_ci_build
        extra_data: release=${nginx_release} application_version=${nginx_version}
          app_name=bf-ngx
    - create_artifactory_yum_repo:
        repo_name: bf-ngx
    publishers:
    - archive:
        artifacts: metadata.txt

- job-template:
    name: '{tla}_integration-tests-{dc}'
    project-type: maven
    logrotate:
      numToKeep: 20
    parameters:
    - string:
        name: virtualmachine
    - string:
        name: package
    wrappers:
    - timestamps
    - ansicolor
    - timeout:
        fail: true
        type: absolute
        timeout: 300
        write-description: "Build timed out (after {{0}} minutes). Marking the build as failed."
    maven:
      maven-name: maven-3.3.9-bf-nexus
      root-pom: pom.xml
      automatic-archiving: false
      goals: validate
      private-repository: local-to-workspace

    jdk: '1.8.0_25'
    prebuilders:
    - shell: |
        cat <<EOF > pom.xml
        <project>

          <modelVersion>4.0.0</modelVersion>
          <name>Maven Default Project</name>

          <artifactId>foo</artifactId>
          <groupId>bar</groupId>
          <version>0.0.1-SNAPSHOT</version>

        </project>
        EOF
