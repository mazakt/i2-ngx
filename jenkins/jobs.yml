- project:
    name: NGX CI jobs
    tla: ngx
    cm: ansible
    cm_scm_group: ansible-roles
    first-environment: qa
    product: bf-nginx
    role: bf-nginx
    dc:
    - 'ie1'
    - 'ie2'
    jobs:
    - '{tla}_{cm}_ci_build'
    - '{tla}_integration-tests-{dc}'
    - '{tla}_package'
    extended-jobs:
    - tla_package_isolated:
        package-metadata:
          dependencies:
            core:
            - name: sena_ansible_build
              project-name: sena_ansible_ci_build
              promotion-name: passed-ci
            - name: sensu_ansible_build
              project-name: sensu_ansible_ci_build
              promotion-name: passed-ci
            - name: mon_build
              project-name: mon_ci_build
              promotion-name: passed-ci
            - name: tspf_ansible_build
              project-name: tspf_ansible_ci_build
              promotion-name: passed-ci
            - name: slgc_ansible_build
              project-name: slgc_ansible_ci_build
              promotion-name: passed-ci
            - name: cpb_ci_build
              project-name: cpb_ci_build
              promotion-name: passed-ci
            alpha:
            - name: ssl_ansible_ci_build
              project-name: ssl_ansible_ci_build
              promotion-name: passed-ci
            - name: bf_jce_base_ansible_ci_build
              project-name: bf_jce_base_ansible_ci_build
              promotion-name: passed-ci
            - name: bf_java_base_ansible_ci_build
              project-name: bf_java_base_ansible_ci_build
              promotion-name: passed-ci
            - name: geoip_ansible_ci
              project-name: geoip_ansible_ci_build
              promotion-name: passed-ci
- job-template: &base_tla_package_definition_multi_dest
    name: '{tla}_package'
    id: 'tla_package_minor_version_multi_dest'
    project-type: freestyle
    version: 0
    quiet-period: 5
    logrotate:
      numToKeep: 30

    package-metadata:
        manifest: '$WORKSPACE/dep-metadata.txt'
        package: '$BUILD_NUMBER'
        metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
        <<: *package-metadata_tla_defaults

    scm:
      - clone_gitlab_project:
          project_path: 'devops/framework'

    publishers:
      - archive:
          artifacts: 'package\{tla}-manifest-$BUILD_NUMBER.{version}.json, dep-metadata.txt'

    wrappers:
      - timestamps
      - mask-passwords
      - workspace-cleanup:
          dirmatch: true
          include: '*'
      - artifactory_push:
          key: 'releases'
          pattern:
           !j2: |
           {% for thisdc in dc -%}
             $WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/{{first_environment|default('qa')}}/,$WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/hotfix/,
           {%- endfor %}

- job-template:
    <<: *base_tla_package_definition_multi_dest
    name: '{tla}_package_isolated_branch'
    id: 'tla_package_minor_version_isolated_branch_multi_dest'
    first-environment-branch: 'qabranch'
    version: 0
    package-metadata:
        manifest: '$WORKSPACE/dep-metadata.txt'
        package: '$BUILD_NUMBER'
        metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
        dependencies:
          core: *package-metadata_tla_defaults_core
          alpha:
            - name: '{tla}_build_branch'
              project-name: '{tla}_ci_build_branch'
              promotion-name: "passed-ci"
              order: 10
            - name: '{tla}_conf_build'
              project-name: 'i2_{tla}_conf_ci'
              promotion-name: "passed-ci"
              order: 20
    wrappers:
      - timestamps
      - mask-passwords
      - workspace-cleanup:
          dirmatch: true
          include: '*'
      - artifactory_push:
          key: 'releases'
          pattern:
            !j2: |
            {% for thisdc in dc -%}
              $WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/{{first_environment_branch|default('qabranch')}}/,
            {%- endfor %}

- job-template:
    <<: *base_tla_package_definition_multi_dest
    id: 'tla_package_minor_version_isolated_base_no_ci_builds_multi_dest'
    version: 0
    package-metadata:
      manifest: '$WORKSPACE/dep-metadata.txt'
      package: '$BUILD_NUMBER'
      metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
      <<: *package-metadata_tla_defaults
      dependencies:
        core: *package-metadata_tla_defaults_core
        alpha:
          - name: '{tla}_conf_build'
            project-name: 'i2_{tla}_conf_ci'
            promotion-name: "passed-ci"
            order: 10

- job-template: &base_tla_package_isolated_definition
    <<: *base_tla_package_definition_multi_dest
    id: 'tla_package_minor_version_isolated_multi_dest'
    version: 0
    package-metadata:
      manifest: '$WORKSPACE/dep-metadata.txt'
      package: '$BUILD_NUMBER'
      metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
      <<: *package-metadata_tla_defaults
      dependencies:
        core: *package-metadata_tla_defaults_core
        alpha:
          - name: '{tla}_build'
            project-name: '{tla}_ci_build'
            promotion-name: "passed-ci"
            order: 10
          - name: '{tla}_conf_build'
            project-name: 'i2_{tla}_conf_ci'
            promotion-name: "passed-ci"
            order: 11
          - name: '{tla}_{cm}_build'
            project-name: '{tla}_{cm}_ci_build'
            promotion-name: "passed-ci"
            order: 12

# Alias for backward compatibility
- job-template:
    <<: *base_tla_package_isolated_definition
    id: 'tla_package_minor_version_isolated_cm_builds_multi_dest'

- job-template:
    <<: *base_tla_package_definition_multi_dest
    id: 'tla_package_minor_version_isolated_builds_multi_dest'
    version: 0
    package-metadata:
      manifest: '$WORKSPACE/dep-metadata.txt'
      package: '$BUILD_NUMBER'
      metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
      <<: *package-metadata_tla_defaults
      dependencies:
        core: *package-metadata_tla_defaults_core
        alpha:
        - name: '{tla}_ci_build'
          project-name: '{tla}_ci_build'
          promotion-name: "passed-ci"
          order: 10
        - name: '{tla}_conf_build'
          project-name: 'i2_{tla}_conf_ci'
          promotion-name: "passed-ci"
          order: 11

- job:
    name: ngx_ci_build
    logrotate:
      numToKeep: 30
    wrappers:
    - timestamps
    - ansicolor
    - workspace-cleanup
    - artifactory_push:
        key: bf-ngx
        pattern: ${workspace}/target/**/*.rpm=>ngx/${BUILD_NUMBER}/
    parameters:
    - devops_ci_build
    - string:
        name: nginx_version
        default: 1.12.2
    - string:
        name: nginx_release
        default: '2'

    builders:
    - get_devops_framework
    - shell: |
        mkdir -p target/x86_64
        wget https://artifactory-prd.prd.betfair/artifactory/centos-epel/7/x86_64/n/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm  -o target/x86_64/nginx-${nginx_version}-${nginx_release}.el7.x86_64.rpm
    - generate_ci_metadata_extra:
        product: ngx_ci_build
        extra_data: release=${nginx_release} application_version=${nginx_version}
          app_name=bf-ngx
    - create_artifactory_yum_repo:
        repo_name: bf-ngx
    publishers:
    - archive:
        artifacts: metadata.txt

- job-template:
    name: '{tla}_integration-tests-{dc}'
    project-type: maven
    logrotate:
      numToKeep: 20
    parameters:
    - string:
        name: virtualmachine
    - string:
        name: package
    wrappers:
    - timestamps
    - ansicolor
    - timeout:
        fail: true
        type: absolute
        timeout: 300
        write-description: "Build timed out (after {{0}} minutes). Marking the build as failed."
    maven:
      maven-name: maven-3.3.9-bf-nexus
      root-pom: pom.xml
      automatic-archiving: false
      goals: validate
      private-repository: local-to-workspace

    jdk: '1.8.0_25'
    prebuilders:
    - shell: |
        cat <<EOF > pom.xml
        <project>

          <modelVersion>4.0.0</modelVersion>
          <name>Maven Default Project</name>

          <artifactId>foo</artifactId>
          <groupId>bar</groupId>
          <version>0.0.1-SNAPSHOT</version>

        </project>
        EOF
        
- job-template: &base_tla_package_definition_multi_dest
    name: '{tla}_package'
    id: 'tla_package_minor_version_multi_dest'
    project-type: freestyle
    version: 0
    quiet-period: 5
    logrotate:
      numToKeep: 30

    package-metadata:
        manifest: '$WORKSPACE/dep-metadata.txt'
        package: '$BUILD_NUMBER'
        metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
        <<: *package-metadata_tla_defaults

    scm:
      - clone_gitlab_project:
          project_path: 'devops/framework'

    publishers:
      - archive:
          artifacts: 'package\{tla}-manifest-$BUILD_NUMBER.{version}.json, dep-metadata.txt'

    wrappers:
      - timestamps
      - mask-passwords
      - workspace-cleanup:
          dirmatch: true
          include: '*'
      - artifactory_push:
          key: 'releases'
          pattern:
           !j2: |
           {% for thisdc in dc -%}
             $WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/{{first_environment|default('qa')}}/,$WORKSPACE/package/*.*=>{{tla}}_package/{{thisdc}}/hotfix/,
           {%- endfor %}

- job-template: &base_tla_package_isolated_definition
    <<: *base_tla_package_definition_multi_dest
    id: 'tla_package_minor_version_isolated_multi_dest'
    version: 0
    package-metadata:
      manifest: '$WORKSPACE/dep-metadata.txt'
      package: '$BUILD_NUMBER'
      metadata: '$WORKSPACE/package/{tla}-manifest-$BUILD_NUMBER.{version}.json'
      <<: *package-metadata_tla_defaults
      dependencies:
        core: *package-metadata_tla_defaults_core
        alpha:
          - name: '{tla}_build'
            project-name: '{tla}_ci_build'
            promotion-name: "passed-ci"
            order: 10
          - name: '{tla}_conf_build'
            project-name: 'i2_{tla}_conf_ci'
            promotion-name: "passed-ci"
            order: 11
          - name: '{tla}_{cm}_build'
            project-name: '{tla}_{cm}_ci_build'
            promotion-name: "passed-ci"
            order: 12